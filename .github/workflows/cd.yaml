name: CD

on:
  push:
    branches: ['main']

permissions:
  contents: read

jobs:
  precheck:
    runs-on: [self-hosted, Linux, X64, activity]
    steps:
      - name: Check kubectl permissions
        run: |
          echo "Checking Kubernetes permissions..."
          kubectl auth can-i delete deployments || (echo "No permission to delete deployments" && exit 1)
          kubectl auth can-i create deployments || (echo "No permission to create deployments" && exit 1)
      - name: Check Docker registry access
        run: |
          echo "Checking Docker registry access..."
          docker info || (echo "Docker not accessible" && exit 1)

  deploy:
    needs: precheck
    runs-on: [self-hosted, Linux, X64, activity]
    environment: 'prod'
    steps:
      - uses: actions/checkout@v4
      - name: Print working directory
        run: |
          pwd
          ls -la
          git status

      - name: Set commit SHA
        id: vars
        run: |
          echo "COMMIT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Create .env file from GitHub Secrets
        run: |
          
          echo "SERVICE_NAME=${{ vars.SERVICE_NAME }}" >> .env

          # Database
          echo "DB_SERVER=${{ secrets.DB_SERVER }}" >> .env
          echo "DB_DATABASE=${{ secrets.DB_DATABASE }}" >> .env
          echo "DB_DATABASE_PORT=${{ secrets.DB_DATABASE_PORT }}" >> .env
          echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" >> .env
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
          echo "DB_DRIVER=${{ secrets.DB_DRIVER }}" >> .env

          # Origins
          echo "WEB_FE_ORIGIN=${{ secrets.WEB_FE_ORIGIN }}" >> .env
          echo "WEB_FE_ORIGIN_STG=${{ secrets.WEB_FE_ORIGIN_STG }}" >> .env     # To be shifted into Environment Secrets with _STG removed when Activity stg server is up
          echo "PATIENT_BE_ORIGIN=${{ secrets.PATIENT_BE_ORIGIN }}" >> .env
          echo "USER_BE_ORIGIN=${{ secrets.USER_BE_ORIGIN }}" >> .env

          # RabbitMQ
          echo "RABBITMQ_HOST=${{ secrets.RABBITMQ_HOST }}" >> .env
          echo "RABBITMQ_PORT=${{ secrets.RABBITMQ_PORT }}" >> .env
          echo "RABBITMQ_USER=${{ secrets.RABBITMQ_USER }}" >> .env
          echo "RABBITMQ_PASS=${{ secrets.RABBITMQ_PASS }}" >> .env
          echo "RABBITMQ_VIRTUAL_HOST=${{ secrets.RABBITMQ_VIRTUAL_HOST }}" >> .env

      - name: Build Docker image
        run: |
          echo "Building Docker image with commit SHA tag..."
          docker build --no-cache -f Dockerfile.dev -t activity_service_dev:${{ env.COMMIT_SHA }} .

      #- name: Tag Docker image
      #  run: |
      #    docker tag activity_service_dev:${{ env.COMMIT_SHA }} localhost:5000/activity_service_dev:${{ env.COMMIT_SHA }}
#
      - name: Push Docker image to local registry
        run: |
          docker push localhost:5000/activity_service_dev:${{ env.COMMIT_SHA }}

      - name: Deploy to Kubernetes (rolling update)
        run: |
          echo "Updating deployment with commit SHA image..."
          kubectl set image deployment/activity-service-dev \
            activity-service=localhost:5000/activity_service_dev:${{ env.COMMIT_SHA }}
          kubectl rollout status deployment/activity-service-dev --timeout=300s

      - name: Deploy Filebeat DaemonSet
        run: |
          kubectl apply -f './k8s/filebeat-daemonset.yaml'

      - name: Kubernetes maintenance cleanup
        run: |
          docker container prune -f
          docker image prune -f
          minikube ssh -- "docker container prune -f && docker image prune -f"
